%toc

MSDN:   https://msdn.microsoft.com/en-us/library/windows/desktop/ee663293%28v=vs.85%29.aspx
Windows Internals
Windwos高级编程

= 安全系统组件 =
*   安全引用监视器(SRM)：Windows执行体中的一个组件。 运行在内核， Ntoskrnl.exe
*   本地安全权威子系统(LSASS)：负责本地系统安全策略、用户认证， 以及发送安全审计消息到事件日志。运行在用户空间的进程， LSass.exe
*   LSASS策略数据库
*   安全账户定理器服务
*   SAM数据库
*   活动目录
*   认证包
*   交互式登录管理器
*   登录用户界面
*   凭证提供者
*   网络登录服务
*   内核安全设备驱动程序(KSecDD):   内核模式函数库， 实现了高级本地过程调用(ALPC)接口
*   AppLocker

= 安全标识符(SID) =
Windows不是使用名称(可能不唯一)来标识系统中执行各种动作的实体， 而是使用安全标识符(SID, security identifier)。
<br>用户有SID， 本地用户组、域中的用户组、本地计算机、域、域成员和服务也都有SID。
<br>SID是一个可变长度的数值， 包含三部分：一个SID结构版本号、一个48位标识符机构值， 以及可变数量的32位子机构值或相对标识符值(RID)。

S-1-5-21-1463437245-1224812800-863842198-1128
文本方式显示的SID， 以S为前缀， 每个部分用连字号分隔
版本号为: 1
标识符机构: 5
子机构值(4个)：21-1463437245-1224812800-863842198-
RID：1128

安装Windows时， Windows Setup程序给计算机灵放一个机器SID(RID前边的部分)。Windows为该计算机上的本地账户分配SID。
<br>每个本地账户SID是以此源计算机制SID为基础的， 只是尾部有一个RID。
<br>用户账户和组的RID是从1000开始的， 对于每个新的用户或组， RID向上递增1。 Administrator账户的RID总是500， Guest的RID为501
<br>Windows也定义了许多内置的本地SID和域SID来代表一些知名的组。 Everyone: S-1-1-0；网络组SID: S-1-5-2

PsGetSid:     Translates SIDs to names and vice versa 
> psgetsid rui_huang
User是账户的友好名称
> psgetsid administrator

= Token =
访问者的安全属性
SRM使用一个称为令牌(或访问令牌)的对象来标识一个进程或线程的安全环境。 安全环境中包含的信息描述了与该进程或线程相关联的账户、组和特权。
<br>令牌也包含了诸如会话ID、完整性级别和UAC虚拟化状态之类的信息。
<br>在登录过程中， LSASS创建一个初始的令牌代表这一次的用户登录， 然后它会确定这一次的登录用户是否属于一个权力较大的组或者拥有一个权力较大的特权

查看访问令牌：
kd> dt nt!_TOKEN    // 在内核调试器中显示内部令牌对象的格式
kd> !process d6c 1  // 显示进程信息
kd> !token afd48720 // 查看该进程的令牌
通过ProcessExplorer查看某个进程的属性对话框->安全标签页

= 安全描述符和访问控制 =
被访问者的安全属性
安全描述符规定了谁可以在对象上执行哪些动作， 该结构中包含如下内容：
*   版本号
*   标志
*   所有者SID
*   组SID
*   自主访问控制列表
*   系统访问控制列表 

查看：
> !object ****
> dt _OBJECT_HEADER Address
> !sd Address & -8

{{{
    安全描述符与访问令牌的关系：
    访问令牌好比是旅行者(也就是主体)的护照， 用来在不同的国界上标识他们自己。安全描述符表示移民法， 由入境国的移民局官员使用，
    根据申请人的来源国描述旅行者的权力和要求。在护照中的所有信息， 例如来源国或者从不同领事馆中获得的签证， 可以被化作不同的
    令牌组成员关系和权力。 移民局， 相当于执行访问检查的代码， 将信任护照的颁发者(在这里相当于操作系统)并且确信护照不是伪造的
    (这在真实世界中很难实现)。根据移民法(安全描述符), 旅行者将被允许或者拒绝进入入境国(访问对象)
}}}

= 用户账户控制(UAC) =
Windows Vista开始引入
User Account Control的意图是让用户能够以标准用户权限， 而不是管理员权限来运行。 同Linux下的sudo方式
<br> UAC让绝大多数应用程序以标准用户权限来运行， 即使该用户已经登录到一个有管理员权限的账户也是如此;
<br> UAC让标准用户能在必要时获得管理员权限， 通过执行一次UAC权限提升实现


        


